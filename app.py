# app.py
import streamlit as st
from core.engine import DecisionEngine, EngineConfig

st.set_page_config(page_title="Decision Mapping Lite", page_icon="ğŸ§­", layout="centered")

@st.cache_resource
def get_engine() -> DecisionEngine:
    return DecisionEngine(EngineConfig())

engine = get_engine()

st.title("ğŸ§­ Decision Mapping Lite (RAG-augmented)")
st.caption("è§„åˆ™æ¨å¯¼ + è¯­ä¹‰æ£€ç´¢å¢å¼ºï¼šæ›´å°‘æ¨¡æ¿æ„Ÿã€æ›´è´´ä½ çš„å†³ç­–è¯­å¢ƒã€‚")

with st.expander("ä½¿ç”¨è¯´æ˜ï¼ˆ30ç§’ï¼‰", expanded=True):
    st.markdown(
        """
- å…ˆä»é»˜è®¤ç¤ºä¾‹å¼€å§‹æ”¹ï¼š**åˆ æ‰ä¸é€‚ç”¨çš„ï¼Œè¡¥å……ä½ çš„äº‹å®**ã€‚
- è¾“å‡ºä¸æ˜¯æ ‡å‡†ç­”æ¡ˆï¼Œè€Œæ˜¯ï¼š**æ¨å¯¼é“¾ + æ£€ç´¢å¢å¼ºçš„é‡æ„/åŠ¨ä½œ/æŠ¤æ  + ä¸‹ä¸€æ­¥**ã€‚
"""
    )

st.divider()

# ---------------------------
# Default demo values (college senior)
# ---------------------------
demo_decision = "æˆ‘æ˜¯ä¸€åå³å°†æ¯•ä¸šçš„å¤§å››å­¦ç”Ÿï¼ˆ2-3ä¸ªæœˆåæ¯•ä¸šï¼‰ï¼Œæ­£åœ¨çº ç»“ï¼šæœªæ¥ 6 ä¸ªæœˆé€‰æ‹©ã€Œç›´æ¥å°±ä¸š / è€ƒç ” / è€ƒå…¬ã€å“ªæ¡è·¯å¾„æ›´åˆé€‚ï¼Ÿ"
demo_options = (
    "è·¯å¾„ Aï¼šç›´æ¥å°±ä¸šï¼ˆå…ˆæ‰¾ä¸€ä»½å·¥ä½œï¼Œè¾¹å·¥ä½œè¾¹æ¢ç´¢æ–¹å‘ï¼‰\n"
    "è·¯å¾„ Bï¼šè€ƒç ”ï¼ˆç›®æ ‡ï¼šæå‡å­¦å†ä¸ä¸“ä¸šèƒ½åŠ›ï¼Œäº‰å–æ›´å¥½çš„å¹³å°ï¼‰\n"
    "è·¯å¾„ Cï¼šè€ƒå…¬ï¼ˆç›®æ ‡ï¼šç¨³å®šä¸é•¿æœŸå®‰å…¨æ„Ÿï¼Œäº‰å–ä½“åˆ¶å†…å‘å±•ï¼‰"
)
demo_status_6m = "æˆ‘å¯èƒ½ä»åœ¨çº ç»“ä¸æŠ•é€’/å¤‡è€ƒä¹‹é—´åå¤åˆ‡æ¢ï¼Œè¡ŒåŠ¨ä¸è¿ç»­ï¼›å‹åŠ›å˜å¤§ä½†è¿›å±•æœ‰é™ã€‚"
demo_status_2y = "å¦‚æœä¸€ç›´æ‹–å»¶ï¼Œå¯èƒ½é”™è¿‡ç§‹æ‹›/æ˜¥æ‹›çª—å£ï¼Œå¤‡è€ƒä¹Ÿæ²¡æœ‰ç³»ç»Ÿç§¯ç´¯ï¼›è‡ªä¿¡å—æŸï¼Œé€‰æ‹©æƒå˜çª„ã€‚"

demo_a_name = "ç›´æ¥å°±ä¸š"
demo_a_best = "æ‹¿åˆ°ä¸€ä»½ç›¸å¯¹åŒ¹é…çš„ offerï¼ˆä¾‹å¦‚æ•°æ®åˆ†æ/è¿è¥/äº§å“åŠ©ç†ï¼‰ï¼Œå¼€å§‹ç§¯ç´¯å·¥ä½œç»éªŒä¸ç°é‡‘æµï¼ŒåŒæ—¶æ›´æ¸…æ¥šè‡ªå·±å–œæ¬¢ä»€ä¹ˆã€‚"
demo_a_worst = "æ‰¾åˆ°çš„å·¥ä½œä¸åŒ¹é…ã€å‹åŠ›å¤§ã€æˆé•¿æ…¢ï¼›åŒæ—¶å¤‡è€ƒ/è½¬å‘æˆæœ¬ä¸Šå‡ï¼Œé™·å…¥â€œå¿™ä½†ä¸è¿›æ­¥â€ã€‚"
demo_a_controls = (
    "æ¯å‘¨å›ºå®š 6â€“8 å°æ—¶åšæ±‚èŒï¼šç®€å†è¿­ä»£ + æŠ•é€’ + é¢è¯•å¤ç›˜\n"
    "åš 1 ä¸ªå¯å±•ç¤ºé¡¹ç›®/ä½œå“ï¼ˆå¦‚æ•°æ®åˆ†ææŠ¥å‘Š/å°äº§å“PRD/ä½œå“é›†ï¼‰\n"
    "æ‰¾ 2 ä½åœ¨ç›®æ ‡å²—ä½çš„å­¦é•¿å­¦å§åšä¿¡æ¯è®¿è°ˆï¼Œæ˜ç¡®æ‹›è˜é—¨æ§›ä¸å¸¸è§å‘\n"
    "è®¾ç½®æ­¢æŸï¼šå¦‚æœ 4 å‘¨æ— ä»»ä½•é¢è¯•è¿›å±•ï¼Œç«‹åˆ»è°ƒæ•´ç­–ç•¥ï¼ˆå²—ä½èŒƒå›´/ç®€å†/é¡¹ç›®ï¼‰"
)

demo_b_name = "è€ƒç ”"
demo_b_best = "è¿›å…¥æ›´å¥½çš„å­¦æ ¡/ä¸“ä¸šï¼Œè·å¾—æ›´å¼ºçš„å¹³å°ä¸èµ„æºï¼Œæ¯•ä¸šåç«äº‰åŠ›æå‡ï¼Œæ–¹å‘æ›´æ¸…æ™°ã€‚"
demo_b_worst = "æŠ•å…¥ä¸€å¹´åè½æ¦œæˆ–ç»“æœä¸€èˆ¬ï¼›åŒæ—¶é”™è¿‡å°±ä¸šçª—å£ï¼Œå¿ƒç†å‹åŠ›ä¸å®¶åº­å‹åŠ›å¢å¤§ã€‚"
demo_b_controls = (
    "æŠŠç›®æ ‡æ‹†æˆ 14 å¤©å†²åˆºï¼šæ¯ä¸¤å‘¨ä¸€ä¸ªå°é—­ç¯ï¼ˆèƒŒè¯µ/åˆ·é¢˜/æ€»ç»“é”™é¢˜ï¼‰\n"
    "æ˜ç¡®ç›®æ ‡é™¢æ ¡ä¸åˆ†æ•°çº¿ï¼Œåšå¯è¡Œæ€§è¯„ä¼°ï¼ˆåŸºç¡€/æ—¶é—´/æ¦‚ç‡ï¼‰\n"
    "æ¯å‘¨ä¸€æ¬¡å¤ç›˜ï¼šè¾“å‡ºå¯é‡åŒ–æŒ‡æ ‡ï¼ˆå­¦ä¹ å°æ—¶æ•°/é¢˜é‡/æ­£ç¡®ç‡ï¼‰\n"
    "è®¾ç½®å¯¹å†²ï¼šä¿ç•™æ¯å‘¨ 2 å°æ—¶çš„å°±ä¸šå‡†å¤‡ï¼ˆç®€å†/å²—ä½ä¿¡æ¯/é¡¹ç›®ï¼‰"
)

demo_priority = "é•¿æœŸé€‰æ‹©æƒï¼ˆOptionalityï¼‰"
demo_constraints = ["æ—¶é—´", "è´¢åŠ¡", "å®¶åº­", "æƒ…ç»ªè€å—åº¦"]
demo_regret = "æ²¡æœ‰å°è¯•"

demo_evidence_commit = (
    "å¦‚æœé€‰æ‹©å°±ä¸šï¼š2â€“4 å‘¨å†…è‡³å°‘è·å¾— 3 æ¬¡é¢è¯•æœºä¼šï¼ˆæˆ– 1 æ¬¡é«˜è´¨é‡å†…æ¨é¢è¯•ï¼‰\n"
    "å¦‚æœé€‰æ‹©è€ƒç ”ï¼šè¿ç»­ 4 å‘¨æ¯å‘¨>=25å°æ—¶å­¦ä¹ ï¼Œä¸”æ­£ç¡®ç‡/åˆ†æ•°æœ‰æ˜ç¡®ä¸Šå‡\n"
    "å¦‚æœé€‰æ‹©è€ƒå…¬ï¼šå®Œæˆä¸€è½®çœŸé¢˜+é”™é¢˜æ•´ç†ï¼Œå¹¶åœ¨æ¨¡æ‹Ÿä¸­è¾¾åˆ°ç›®æ ‡çº¿é™„è¿‘"
)
demo_evidence_stop = (
    "å¦‚æœé€‰æ‹©å°±ä¸šï¼šè¿ç»­ 4 å‘¨æŠ•é€’>80 ä½†0é¢è¯•ï¼Œè¯´æ˜ç­–ç•¥æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ„æ–¹å‘/ç®€å†/é¡¹ç›®\n"
    "å¦‚æœé€‰æ‹©è€ƒç ”ï¼šè¿ç»­ 2 å‘¨æ˜æ˜¾æ— æ³•æŠ•å…¥ï¼ˆå¥åº·/ç„¦è™‘/å®¶åº­å†²çªï¼‰ï¼Œå…ˆé™æ³¢åŠ¨å†ç»§ç»­\n"
    "å¦‚æœé€‰æ‹©è€ƒå…¬ï¼šå­¦ä¹ æŠ•å…¥ç¨³å®šä½†æˆç»©é•¿æœŸæ— æå‡ï¼Œéœ€è¦é‡æ–°è¯„ä¼°å²—ä½/æ–¹æ³•/æ˜¯å¦é€‚é…"
)
demo_partial_control = (
    "æ—¶é—´å—ï¼ˆéƒ¨åˆ†å¯æ§ï¼‰ï¼šæ¯å¤©å›ºå®š 90 åˆ†é’Ÿâ€œæ·±åº¦å—â€ï¼Œä¸è¢«æ‰‹æœº/ç¤¾äº¤æ‰“æ–­ï¼›å‘¨æœ« 2 ä¸ª 3 å°æ—¶å—åšé—­ç¯è¾“å‡ºã€‚\n"
    "æƒ…ç»ªè€å—ï¼ˆéƒ¨åˆ†å¯æ§ï¼‰ï¼šå…ˆæŠŠâ€œç»ˆèº«å†³å®šâ€é™çº§ä¸ºâ€œä¸¤å‘¨è¯•æ¢â€ï¼Œç”¨è¯æ®é©±åŠ¨ï¼Œè€Œä¸æ˜¯æƒ…ç»ªé©±åŠ¨ã€‚"
)
demo_identity_anchor = "æˆ‘æƒ³æˆä¸ºä¸€ä¸ªèƒ½åœ¨ä¸ç¡®å®šä¸­ä¿æŒç¨³å®šæ¨è¿›çš„äººï¼šä¸é æƒ…ç»ªåšé‡å¤§å†³å®šï¼Œè€Œé ç»“æ„åŒ–è¯•æ¢ä¸è¯æ®æ¥æ”¶æ•›è·¯å¾„ã€‚"

# ---------------------------
# Inputs (prefilled)
# ---------------------------
decision = st.text_area(
    "1) ä½ æ­£åœ¨é¢å¯¹çš„å…³é”®å†³ç­–æ˜¯ä»€ä¹ˆï¼Ÿ",
    value=demo_decision,
    height=90,
)

options = st.text_area(
    "2) ä½ çš„å¤‡é€‰è·¯å¾„æœ‰å“ªäº›ï¼Ÿï¼ˆè‡³å°‘2ä¸ªï¼‰",
    value=demo_options,
    height=130,
)

status_6m = st.text_area(
    "3) å¦‚æœä½ ä»€ä¹ˆéƒ½ä¸æ”¹å˜ï¼š6ä¸ªæœˆåæœ€å¯èƒ½æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ",
    value=demo_status_6m,
    height=90,
)

status_2y = st.text_area(
    "4) å¦‚æœä½ ä»€ä¹ˆéƒ½ä¸æ”¹å˜ï¼š2å¹´åæœ€å¯èƒ½æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ",
    value=demo_status_2y,
    height=90,
)

st.subheader("è·¯å¾„æ‹†è§£ï¼ˆA / B å¿…å¡«ï¼‰")
col1, col2 = st.columns(2)

with col1:
    st.markdown("### è·¯å¾„ A")
    a_name = st.text_input("A çš„åå­—ï¼ˆç®€çŸ­ï¼‰", value=demo_a_name)
    a_best = st.text_area("Aï¼šæœ€å¥½ç»“æœ", value=demo_a_best, height=90)
    a_worst = st.text_area("Aï¼šæœ€åç»“æœ", value=demo_a_worst, height=90)
    a_controls = st.text_area("Aï¼šå¯æ§å˜é‡ï¼ˆä½ èƒ½åšä»€ä¹ˆæ¥é™ä½é£é™©ï¼‰", value=demo_a_controls, height=120)

with col2:
    st.markdown("### è·¯å¾„ B")
    b_name = st.text_input("B çš„åå­—ï¼ˆç®€çŸ­ï¼‰", value=demo_b_name)
    b_best = st.text_area("Bï¼šæœ€å¥½ç»“æœ", value=demo_b_best, height=90)
    b_worst = st.text_area("Bï¼šæœ€åç»“æœ", value=demo_b_worst, height=90)
    b_controls = st.text_area("Bï¼šå¯æ§å˜é‡ï¼ˆä½ èƒ½åšä»€ä¹ˆæ¥é™ä½é£é™©ï¼‰", value=demo_b_controls, height=120)

st.subheader("ç›®æ ‡ä¸çº¦æŸ")
priority = st.radio(
    "5) ç°åœ¨å¯¹ä½ æœ€é‡è¦çš„æ˜¯å“ªä¸€ä¸ªï¼Ÿ",
    ["ç¨³å®šæ€§", "æ”¶å…¥", "æˆé•¿", "è‡ªç”±åº¦", "é•¿æœŸé€‰æ‹©æƒï¼ˆOptionalityï¼‰"],
    index=["ç¨³å®šæ€§", "æ”¶å…¥", "æˆé•¿", "è‡ªç”±åº¦", "é•¿æœŸé€‰æ‹©æƒï¼ˆOptionalityï¼‰"].index(demo_priority),
)

constraints = st.multiselect(
    "6) ä½ ç°åœ¨çš„çœŸå®çº¦æŸæ˜¯ï¼Ÿï¼ˆå¤šé€‰ï¼‰",
    ["è´¢åŠ¡", "æ—¶é—´", "å®¶åº­", "æŠ€èƒ½å·®è·", "æƒ…ç»ªè€å—åº¦", "å¥åº·", "åœ°ç†ä½ç½®", "èº«ä»½/è‡ªæˆ‘å™äº‹", "å…¶ä»–"],
    default=demo_constraints,
)

regret = st.radio(
    "7) 5å¹´åçš„ä½ å›çœ‹ä»Šå¤©ï¼šæ›´å¯èƒ½åæ‚”å“ªä¸€ç§ï¼Ÿ",
    ["æ²¡æœ‰å°è¯•", "å†’é™©å¤±è´¥"],
    index=["æ²¡æœ‰å°è¯•", "å†’é™©å¤±è´¥"].index(demo_regret),
)

st.subheader("è¯æ®ä¸è¯•æ¢ï¼ˆä½ çš„é£æ ¼æ ¸å¿ƒï¼‰")
evidence_to_commit = st.text_area(
    "8) ä½ éœ€è¦çœ‹åˆ°ä»€ä¹ˆè¯æ®ï¼Œæ‰ä¼šå¯¹æŸæ¡è·¯å¾„â€œåŠ ç /æ‰¿è¯ºâ€ï¼Ÿï¼ˆè¯æ®é—¨æ§›ï¼‰",
    value=demo_evidence_commit,
    height=120,
)
evidence_to_stop = st.text_area(
    "9) ä½ éœ€è¦çœ‹åˆ°ä»€ä¹ˆä¿¡å·ï¼Œæ‰ä¼šâ€œæ­¢æŸ/æ¢è·¯å¾„â€ï¼Ÿï¼ˆæ­¢æŸæ¡ä»¶ï¼‰",
    value=demo_evidence_stop,
    height=120,
)
partial_control = st.text_area(
    "10) ä½ ç°åœ¨æœ€å…³é”®çš„ã€Œéƒ¨åˆ†å¯æ§ã€å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿä½ å‡†å¤‡æ€ä¹ˆæŠŠå®ƒå¾€æœ‰åˆ©æ–¹å‘æ¨ä¸€ç‚¹ï¼Ÿ",
    value=demo_partial_control,
    height=120,
)
identity_anchor = st.text_area(
    "11) è¿™ä¸ªå†³ç­–ä¸ä½ æƒ³æˆä¸ºçš„é‚£ç§äººæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿï¼ˆèº«ä»½è½¨è¿¹é”šï¼‰",
    value=demo_identity_anchor,
    height=90,
)

st.divider()

go = st.button("âœ… ç”Ÿæˆæˆ‘çš„å†³ç­–å¤‡å¿˜å½•", type="primary", use_container_width=True)

if go:
    payload = dict(
        decision=decision,
        options=options,
        status_6m=status_6m,
        status_2y=status_2y,
        a_name=a_name, a_best=a_best, a_worst=a_worst, a_controls=a_controls,
        b_name=b_name, b_best=b_best, b_worst=b_worst, b_controls=b_controls,
        priority=priority,
        constraints=constraints,
        regret=regret,
        evidence_to_commit=evidence_to_commit,
        evidence_to_stop=evidence_to_stop,
        partial_control=partial_control,
        identity_anchor=identity_anchor,
    )

    memo = engine.build_memo_cn(payload)
    st.success("å·²ç”Ÿæˆï¼ˆå«è¯­ä¹‰æ£€ç´¢å¢å¼ºï¼‰ã€‚")
    st.code(memo, language="markdown")
    st.download_button(
        "â¬‡ï¸ ä¸‹è½½ä¸º Markdownï¼ˆ.mdï¼‰",
        data=memo.encode("utf-8"),
        file_name="decision_memo.md",
        mime="text/markdown",
        use_container_width=True,
    )
